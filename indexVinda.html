<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>react-demo</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script>
        (function() {
            document.body.innerText="";
            var body = document.getElementsByTagName('body').item(0);
            var link = document.createElement('div');
            link.id = 'app';
            link.style = "height: 100%";
            body.appendChild(link);
        })();
    (function(t){function z(){for(var a=0;a<g.length;a++)g[a][0](g[a][1]);g=[];m=!1}function n(a,b){g.push([a,b]);m||(m=!0,A(z,0))}function B(a,b){function c(a){p(b,a)}function h(a){k(b,a)}try{a(c,h)}catch(d){h(d)}}function u(a){var b=a.owner,c=b.state_,b=b.data_,h=a[c];a=a.then;if("function"===typeof h){c=l;try{b=h(b)}catch(d){k(a,d)}}v(a,b)||(c===l&&p(a,b),c===q&&k(a,b))}function v(a,b){var c;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(b&&("function"===
        typeof b||"object"===typeof b)){var h=b.then;if("function"===typeof h)return h.call(b,function(d){c||(c=!0,b!==d?p(a,d):w(a,d))},function(b){c||(c=!0,k(a,b))}),!0}}catch(d){return c||k(a,d),!0}return!1}function p(a,b){a!==b&&v(a,b)||w(a,b)}function w(a,b){a.state_===r&&(a.state_=x,a.data_=b,n(C,a))}function k(a,b){a.state_===r&&(a.state_=x,a.data_=b,n(D,a))}function y(a){var b=a.then_;a.then_=void 0;for(a=0;a<b.length;a++)u(b[a])}function C(a){a.state_=l;y(a)}function D(a){a.state_=q;y(a)}function e(a){if("function"!==
        typeof a)throw new TypeError("Promise constructor takes a function argument");if(!1===this instanceof e)throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this.then_=[];B(a,this)}var f=t.Promise,s=f&&"resolve"in f&&"reject"in f&&"all"in f&&"race"in f&&function(){var a;new f(function(b){a=b});return"function"===typeof a}();"undefined"!==typeof exports&&exports?(exports.Promise=s?f:e,exports.Polyfill=e):"function"==
        typeof define&&define.amd?define(function(){return s?f:e}):s||(t.Promise=e);var r="pending",x="sealed",l="fulfilled",q="rejected",E=function(){},A="undefined"!==typeof setImmediate?setImmediate:setTimeout,g=[],m;e.prototype={constructor:e,state_:r,then_:null,data_:void 0,then:function(a,b){var c={owner:this,then:new this.constructor(E),fulfilled:a,rejected:b};this.state_===l||this.state_===q?n(u,c):this.then_.push(c);return c.then},"catch":function(a){return this.then(null,a)}};e.all=function(a){if("[object Array]"!==
        Object.prototype.toString.call(a))throw new TypeError("You must pass an array to Promise.all().");return new this(function(b,c){function h(a){e++;return function(c){d[a]=c;--e||b(d)}}for(var d=[],e=0,f=0,g;f<a.length;f++)(g=a[f])&&"function"===typeof g.then?g.then(h(f),c):d[f]=g;e||b(d)})};e.race=function(a){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("You must pass an array to Promise.race().");return new this(function(b,c){for(var e=0,d;e<a.length;e++)(d=a[e])&&"function"===
        typeof d.then?d.then(b,c):b(d)})};e.resolve=function(a){return a&&"object"===typeof a&&a.constructor===this?a:new this(function(b){b(a)})};e.reject=function(a){return new this(function(b,c){c(a)})}})("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this);
    </script>
    <script>
      window.manifest=[{name:"vendors-dll.js",res:"https://h5test.ichangtou.com/minic/vinda/vendors-dll.js",type:"js"},{name:"bundle.js",res:"https://h5test.ichangtou.com/minic/vinda/bundle.js",type:"js"}];var _VINDA_={};_VINDA_.executeVindaByConfig=function(e){return new Promise(function(t,n){if(window.localStorage){for(var o=[],s=0;s<e.length;s++)this.checkVersion(e[s])||(console.log("push",e[s].name),o.push(this.upSertResource(e[s])));this.executeXHRTasks(o).then(function(){for(var n=0;n<e.length;n++)switch(e[n].type){case"js":console.log("inJectJS"),_VINDA_.inJectJS(e[n]);break;case"css":console.log("inJectCSS"),_VINDA_.inJectCSS(e[n])}t()}.bind(this))}else alert("您的微信版本号过低")}.bind(this))},_VINDA_.executeVinda=function(){if(window.localStorage){for(var e=[],t=0;t<window.manifest.length;t++)this.checkVersion(window.manifest[t])||e.push(this.upSertResource(window.manifest[t]));this.executeXHRTasks(e).then(function(){for(var e=0;e<window.manifest.length;e++)switch(window.manifest[e].type){case"js":console.log("inJectJS"),_VINDA_.inJectJS(window.manifest[e]);break;case"css":console.log("inJectCSS"),_VINDA_.inJectCSS(window.manifest[e])}})}else alert("您的微信版本号过低")},_VINDA_.executeXHRTasks=function(e){var t=0;return new Promise(function(n,o){0===e.length&&n();for(var s=0;s<e.length;s++)!function(){var o=e[s];o.XHRHttp.onreadystatechange=function(){4==o.XHRHttp.readyState&&200==o.XHRHttp.status&&(t++,console.log("get",o.name),window.localStorage.setItem("_VINDA_"+o.name,o.XHRHttp.responseText),window.localStorage.setItem("_vinda_"+o.name,o.res),t===e.length&&n())},o.XHRHttp.send()}()})},_VINDA_.checkVersion=function(e){return window.localStorage.getItem("_vinda_"+e.name)===e.res},_VINDA_.upSertResource=function(e){var t;return(t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).open("GET",e.res,!0),t.setRequestHeader("Cache-Control","no-cache"),{XHRHttp:t,name:e.name,res:e.res}},_VINDA_.inJectCSS=function(e){var t=document.getElementsByTagName("body").item(0),n=document.createElement("style");n.type="text/css",n.innerHTML=localStorage.getItem("_VINDA_"+e.name),t.appendChild(n)},_VINDA_.inJectJS=function(e){var t=document.getElementsByTagName("body").item(0),n=document.createElement("script");n.type="text/javascript",n.innerHTML=localStorage.getItem("_VINDA_"+e.name),t.appendChild(n)},Object.freeze(_VINDA_);
    </script>


    <script>
            // defined wx global config
            window._WXGLOBAL_ = (function () {
                var _ENVIRONMENT = (function () {
                    if (location.href.indexOf('h5.ichangtou.com') > -1) {
                        return true;
                    } else {
                        return false;
                    }
                })();
                var __debug__ = location.href.indexOf('localhost') > 0;
                var __TEST_API_Token__ = 'XX:_:w2qlJFV@ccOeiq41ENp><ETXh3o@aX8M<[_QOsZ<d8[Yz:NIMcKwpjtBk0e';
                var _FORMAL_API_DOMAIN = 'https://growth.ichangtou.com/';
                var _TEST_API_DOMAIN = 'https://geek.ichangtou.com/';
                var __API_URL_DOMAIN__ = _ENVIRONMENT ? _FORMAL_API_DOMAIN : _TEST_API_DOMAIN;
                var __TEST_APPID__ = 'wx7cf8dd5d80048e42';
                var __FORMA_APPID__ = 'wx8cc2299282e864f8';
                var __APPID__ = _ENVIRONMENT ? __FORMA_APPID__ : __TEST_APPID__;
                var __API_URL_GROUP__ = {
                    'wx_sign': 'wx/signature',
                    'userinfo_authorization': 'wx/h5/info/login/OA_CTW',
                    'base_login': 'wx/h5/base/login/OA_CTW',
                    'get_order': 'payment/wx/jsapi/order',
                };
                Object.freeze(__API_URL_GROUP__);
                var __JSAPILIST__ = [
                    'onMenuShareTimeline',
                    'onMenuShareAppMessage',
                    'onMenuShareQQ',
                    'onMenuShareWeibo'
                ];
            
                var __SHARE_DESC__ = '新版react~';
                var __SHARE_TITLE__ = '我是标题';
            
                //支付AppID
                var _TEST_PAID_APPID = 'wx7cf8dd5d80048e42';
                var _FORMAL_PAID_APPID = 'wxd6c823882698f217';
            
                //支付APPID
                var __PAID_APPID__ = _ENVIRONMENT ? _FORMAL_PAID_APPID : _TEST_PAID_APPID;
                var __PAYPULLINGFLAG__ = false;
                var __COURSE_SUM__ = 1;
                return {
                    __debug__: __debug__,
                    __PAYPULLINGFLAG__: __PAYPULLINGFLAG__,
                    __API_URL_DOMAIN__: __API_URL_DOMAIN__,
                    __TEST_API_Token__: __TEST_API_Token__,
                    __API_URL_GROUP__: __API_URL_GROUP__,
                    __APPID__: __APPID__,
                    __JSAPILIST__: __JSAPILIST__,
                    __SHARE_DESC__: __SHARE_DESC__,
                    __SHARE_TITLE__: __SHARE_TITLE__,
                    __PAID_APPID__: __PAID_APPID__,
                    __COURSE_SUM__: __COURSE_SUM__
                };
            })(window);
            
            Object.freeze(window._WXGLOBAL_);
            
            var WXSDK = {};
            WXSDK.InitWxApi = function () {
                if (!WXSDK._getUrlPara('code')) {
                    WXSDK._redirectToBaseInfo();
                } else {
                    WXSDK._getUserInfoFromServer().then(function (response) {
                        var data = response.json();
                        console.log(data);
                        data.then(function (data) {
                            if (!data || !data.userId) {
                                WXSDK._redirectToUserInfo();
                                return true;
                            }
                            var userInfo = {
                                userId: data.userId,
                                sessionId: data.sessionId,
                                openId: data.openId,
                                nickName: data.nickName,
                                headImage: data.headImage,
                                payOpenId: data.payOpenId,
                                subscribe: data.subscribe
                            };
                
                            if (userInfo.nickName && userInfo.nickName.length > 10) {
                                userInfo.nickName = userInfo.nickName.substr(0, userInfo.nickName.length - 6);
                            }
                            console.log('userInfo333333', userInfo);
                            alert(userInfo.nickName);
                            localStorage.setItem('wx-user-info', JSON.stringify(userInfo));
                            WXSDK._isWeiXin() && WXSDK._signWxApi().then(function (response) {
                                var date = response.json();
                                date.then(function (date) {
                                    wx.config({
                                        appid: date.wechat_appid,
                                        timestamp: date.timestamp,
                                        nonceStr: date.nonceStr,
                                        signature: date.signature,
                                        __JSAPILIST__: window._WXGLOBAL_.__JSAPILIST__,
                                    });
                                    WXSDK.shareConfig();
                                });
                            });
                        })
                    }, function() {
                        WXSDK._redirectToUserInfo();
                    })
                }
            };
            
            WXSDK._getUserInfoFromServer = function () {
                // inject vinda
                _VINDA_.executeVinda();
                var code = WXSDK._getUrlPara('code');
                var jsonData = JSON.stringify({
                    'code': code
                });
                var APIUrl = WXSDK._getAPIUrl('base_login');
                if (WXSDK._getUrlPara('isuserinfo')) {
                    APIUrl = WXSDK._getAPIUrl('userinfo_authorization');
                    jsonData = JSON.stringify({
                        'code': code,
                        'channel': '31'
                    });
                }
                return fetch(APIUrl, {
                    method: "POST",
                    body: jsonData,
                    headers: {
                        "Accept": "application/json",
                        "X-iChangTou-Json-Api-Token": window._WXGLOBAL_.__TEST_API_Token__,
                        "Content-Type": "application/json;charset=utf-8"
                    },
                });
            }
            WXSDK._getAppId = function () {
                return window._WXGLOBAL_.__APPID__;
            };
            
            WXSDK._getPoundSignUrl = function () {
                return location.href.split('#')[1];
            };
            WXSDK._getHtmlUrl = function () {
                return location.protocol + "//" + location.host + location.pathname;
            };
            
            
            WXSDK.shareConfig = function () {
                var USER_INFO = JSON.parse(localStorage.getItem('wx-user-info'));
            
                var imgUrl = USER_INFO.headImage,
            
                    link = WXSDK._getShareUrl(),
            
                    desc = window._WXGLOBAL_.__SHARE_DESC__,
            
                    title = window._WXGLOBAL_.__SHARE_TITLE__;
            
                if (!imgUrl) {
                    imgUrl = 'http://h5test.ichangtou.com.cn/minic/shareLogo.png';
                }
                var timelineOpt = {
                    title:title,
                    desc:desc,
                    link:link,
                    imgUrl:imgUrl,
                    success: function() {
                        //'朋友圈'
                        WXSDK._onShareSuccess();
                    },
                    cancel: function() {
                        WXSDK._onShareFailure();
                    }
                },
                messageOpt = {
                    title:title,
                    desc:desc,
                    link:link,
                    imgUrl:imgUrl,
                        success: function() {
                            //'消息'
                            WXSDK._onShareSuccess();
                        },
                        cancel: function() {
                            WXSDK._onShareFailure();
                        }
                    },
                    QQOpt = {
                        title:title,
                        desc:desc,
                        link:link,
                        imgUrl:imgUrl,
                        success: function() {
                            //'QQ'
                            WXSDK._onShareSuccess();
                        },
                        cancel: function() {
                            WXSDK._onShareFailure();
                        }
                    },
                    weiboOpt = {
                        title:title,
                        desc:desc,
                        link:link,
                        imgUrl:imgUrl,
                        success: function() {
                            //微博
                            WXSDK._onShareSuccess();
                        },
                        cancel: function() {
                            WXSDK._onShareFailure();
                        }
                    };
            
                wx.onMenuShareTimeline(timelineOpt);
                wx.onMenuShareAppMessage(messageOpt);
                wx.onMenuShareQQ(QQOpt);
                wx.onMenuShareWeibo(weiboOpt);
            
            };
            
            WXSDK._onShareSuccess = function () {
                WXSDK.wechatPay();
            };
            
            WXSDK._onShareFailure = function () {
                console.log('分享失败')
            };
            
            
            WXSDK._getShareUrl = function () {
                var userInfo = JSON.parse(localStorage.getItem('wx-user-info'));
                return WXSDK._getHtmlUrl() + "?share=" + userInfo.userId + "#" + WXSDK._getPoundSignUrl();
            };
            
            WXSDK.wechatPay = function () {
                var userInfo = JSON.parse(localStorage.getItem('wx-user-info'));
                if (window._WXGLOBAL_.__PAYPULLINGFLAG__) {
                    //如果正在拉取支付数据，阻止，避免重复请求
                    setTimeout(function() {
                        window._WXGLOBAL_.__PAYPULLINGFLAG__ = false;
                    }, 3000);
                }
                var price = 1;
                if (price) {
                    WXSDK._getOrder(userInfo.userId, price);
                } else {
                    console.log('支付失败，获取成本价格为空');
                }
            
            };
            
            WXSDK._getOrder = function (userId, sum) {
                if (window._WXGLOBAL_.__PAYPULLINGFLAG__) {
                    return;
                }
                if (!userId) {
                    console.log('没有用户信息');
                    return;
                }
                var userInfo = JSON.parse(localStorage.getItem('wx-user-info'));
                if (!sum) {
                    sum = window._WXGLOBAL_.__COURSE_SUM__;
                }
                var jsonData = JSON.stringify({
                    "body": '商品成本费',
                    "deal": {
                        "items": [{
                            dealType: 102, //交易类型
                            itemId: 2,
                            mchantType: 11, //商品类型
                            misc: '',
                            price: sum
                        }]
                    },
                    "openId": userInfo.payOpenId && userInfo.payOpenId.toString(),
                    "sum": sum
                });
                var apiUrl = WXSDK._getAPIUrl('get_order');
                window._WXGLOBAL_.__PAYPULLINGFLAG__ = true;
                return fetch(apiUrl, {
                    method: "POST",
                    body: jsonData,
                    headers: {
                        "Accept": "application/json",
                        "X-iChangTou-Json-Api-Token": window._WXGLOBAL_.__TEST_API_Token__,
                        "Content-Type": "application/json;charset=utf-8",
                        "X-iChangTou-Json-Api-User": userInfo.userId,
                        "X-iChangTou-Json-Api-Session": userInfo.sessionId,
                    },
                }).then(function (response) {
                    response.json().then(function (data) {
                        localStorage.setItem('wx-user-pay', JSON.stringify(data));
                        WXSDK._pay();
                    })
                }).catch(function (data) {
                    console.log('请求微信支付失败', data);
                })
            };
            
            WXSDK._pay = function () {
            
                var data = JSON.parse(localStorage.getItem('wx-user-pay'));
                if (typeof WeixinJSBridge == "undefined") {
                    if (document.addEventListener) {
                        document.addEventListener('WeixinJSBridgeReady', WXSDK._pay, false);
                    } else if (document.attachEvent) {
                        document.attachEvent('WeixinJSBridgeReady', WXSDK._pay);
                        document.attachEvent('onWeixinJSBridgeReady', WXSDK._pay);
                    }
                } else {
                    WXSDK._onBridgeReady(data);
                }
            };
            
            
            WXSDK._onBridgeReady = function () {
                var param = {
                    "appid": window._WXGLOBAL_.__PAID_APPID__,
                    "timeStamp": data.timeStamp.toString(),
                    "nonceStr": data.nonceStr,
                    "package": ("prepay_id=" + data.prepayId.toString()),
                    "signType": "MD5",
                    "paySign": data.paySign
                };
                WeixinJSBridge.invoke(
                    'getBrandWCPayRequest',
                    param,
                    function res() {
                        //标记请求支付完成
                        window._WXGLOBAL_.__PAYPULLINGFLAG__ = false;
                        if (res.err_msg == "get_brand_wcpay_request:ok") {
                            //支付成功
                            console.log('支付成功')
                        } else {
                            //取消支付
                            console.log('支付失败')
            
                        }
                    }
                );
            };
            WXSDK._getAPIUrl = function (type) {
                return WXSDK._getAPIDomain() + window._WXGLOBAL_.__API_URL_GROUP__[type];
            };
            
            WXSDK._getAPIDomain = function () {
                return window._WXGLOBAL_.__API_URL_DOMAIN__;
            };
            
            WXSDK._redirectToBaseInfo = function () {
                if (window._WXGLOBAL_.__debug__ || !WXSDK._isWeiXin()) {
                    return;
                }
                var code = WXSDK._getUrlPara('code');
                var redirectUri = WXSDK._getRedirectUri(false),
                    scope = 'snsapi_base'; //snsapi_userinfo;
                localStorage.removeItem('userInfoErrCounter');
                var url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + WXSDK._getAppId() +
                    '&redirect_uri=' + redirectUri +
                    '&response_type=code' +
                    '&scope=' + scope +
                    '&state=new#wechat_redirect';
                window.location.href = url;
            };
            WXSDK._getRedirectUri = function (isUserInfo) {
                var redirectUri = WXSDK._getHtmlUrl(),
                    prefix = '?';
                if (!isUserInfo) {
                    //区分baseInfo和userInfo
                    prefix = '?';
                    redirectUri = redirectUri + prefix + 'isuserinfo=1';
                }
                var code = WXSDK._getUrlPara('code');
                return encodeURIComponent(redirectUri);
            };
            
            WXSDK._redirectToUserInfo = function () {
                if (!WXSDK._isWeiXin()) {
                    return;
                }
                var redirectUri = WXSDK._getRedirectUri(true),
                    scope = 'snsapi_userinfo'; //snsapi_userinfo
            
                var errCounter = 0;
                if (localStorage.getItem('userInfoErrCounter')) {
                    errCounter = parseInt(localStorage.getItem('userInfoErrCounter'));
                }
                if (errCounter > 3) {
                    localStorage.removeItem('userInfoErrCounter');
                    return;
                } else {
                    localStorage.setItem('userInfoErrCounter', (errCounter + 1).toString());
                }
                var url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + WXSDK._getAppId() +
                    '&redirect_uri=' + redirectUri +
                    '&response_type=code' +
                    '&scope=' + scope +
                    '&state=minic#wechat_redirect';
            
                window.location.href = url;
            };
            WXSDK._getUrlPara = function (key) {
                var href = location.href,
                    res = href.split(key + '=');
                if (res[1]) {
                    res = decodeURIComponent(res[1].split('&')[0]);
                } else {
                    res = null;
                }
                return res;
            };
            
            WXSDK._signWxApi = function () {
                return fetch(WXSDK._getAPIUrl('wx_sign'), {
                    method: "POST",
                    body: JSON.stringify({
                        "url": location.href
                    }),
                    headers: {
                        "Accept": "application/json",
                        "X-iChangTou-Json-Api-Token": window._WXGLOBAL_.__TEST_API_Token__,
                        "Content-Type": "application/json;charset=utf-8"
                    },
                });
            
            };
            WXSDK._isWeiXin = function () {
                var ua = navigator.userAgent.toLowerCase();
            
                if (ua.match(/MicroMessenger/i) !== null && ua.match(/MicroMessenger/i)[0] === "micromessenger") {
                    return true;
                } else {
                    return false;
                }
            };
            
            Object.freeze(WXSDK);
            
            window.onload = function () {
                if (!window.fetch) {
                    _VINDA_.executeVindaByConfig([{
                        name: 'fetch.js',
                        res: 'https://h5test.ichangtou.com/minic/vinda/fetch-polyfill.js',
                        type: 'js'
                    }]);
                }
                _VINDA_.executeVindaByConfig([{
                    name: 'jweixin.js',
                    res: 'https://h5test.ichangtou.com/minic/vinda/jweixin.js',
                    type: 'js'
                }]).then(function() {
                    WXSDK.InitWxApi();
                });
            }
    </script>
</head>

<body>
    <div id="app" style="height: 100%"></div>
    <!-- built files will be auto injected -->
</body>

</html>